name: Generate blog posts index

on:
  push:
    branches: ["main"]
    paths:
      - "blog/**"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate blog/posts.json
        run: |
          python3 - << 'PY'
          import os, json, re

          BLOG_PATH = "blog"
          out = []

          def get_meta(html, name):
            m = re.search(rf'<meta\\s+name="{re.escape(name)}"\\s+content="([^"]*)"', html, re.I)
            return m.group(1).strip() if m else ""

          def get_title(html, slug):
            m = re.search(r"<title>(.*?)</title>", html, re.I|re.S)
            t = (m.group(1).strip() if m else slug)
            t = t.replace("— BitDark Blog","").replace("— BitDark","").strip()
            return t

          for slug in sorted(os.listdir(BLOG_PATH)):
            if slug.startswith("_"):
              continue
            folder = os.path.join(BLOG_PATH, slug)
            if not os.path.isdir(folder):
              continue
            path = os.path.join(folder, "index.html")
            if not os.path.exists(path):
              continue

            html = open(path, "r", encoding="utf-8", errors="ignore").read()

            title = get_title(html, slug)
            desc  = get_meta(html, "description") or "Practical guide from BitDark.NET."
            cat   = get_meta(html, "bd:category") or "General"
            tags  = get_meta(html, "bd:tags") or ""
            upd   = get_meta(html, "bd:updated") or "1970-01-01"

            out.append({
              "slug": slug,
              "title": title,
              "description": desc,
              "category": cat,
              "tags": [t.strip() for t in tags.split(",") if t.strip()],
              "updated": upd,
              "keywords": f"{title} {desc} {cat} {tags} {slug}".lower()
            })

          open(os.path.join(BLOG_PATH, "posts.json"), "w", encoding="utf-8").write(
            json.dumps(out, ensure_ascii=False, indent=2)
          )
          PY

      - name: Commit and push (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add blog/posts.json
          git diff --cached --quiet || git commit -m "Auto-generate blog posts index"
          git push
