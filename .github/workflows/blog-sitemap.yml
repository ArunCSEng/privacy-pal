name: Auto-generate blog sitemap

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  generate-blog-sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate blog-sitemap.xml
        run: |
          echo '<?xml version="1.0" encoding="UTF-8"?>' > blog-sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> blog-sitemap.xml

          for file in blog/*/index.html; do
            SLUG=$(basename "$(dirname "$file")")

            # Skip non-post folders
            if [ "$SLUG" = "index.html" ]; then
              continue
            fi

            UPDATED=$(grep -oP '(?<=bd:updated" content=")[^"]+' "$file" || echo "")
            [ -z "$UPDATED" ] && UPDATED=$(date +%F)

            echo "  <url>" >> blog-sitemap.xml
            echo "    <loc>https://bitdark.net/blog/$SLUG/</loc>" >> blog-sitemap.xml
            echo "    <lastmod>$UPDATED</lastmod>" >> blog-sitemap.xml
            echo "    <changefreq>monthly</changefreq>" >> blog-sitemap.xml
            echo "    <priority>0.8</priority>" >> blog-sitemap.xml
            echo "  </url>" >> blog-sitemap.xml
          done

          echo '</urlset>' >> blog-sitemap.xml

      - name: Commit and push sitemap
        run: |
          git config user.name "bitdark-bot"
          git config user.email "bot@bitdark.net"
          git add blog-sitemap.xml
          git commit -m "Auto-update blog-sitemap.xml" || exit 0
          git push